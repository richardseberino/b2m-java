



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="https://rafal-szypulka.github.io/b2m-java/ICP/">
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.2.0">
    
    
      
        <title>5. Deploy to IBM Cloud Private - Build to Manage - Java application monitoring and logging lab</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.572ca0f0.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.8c900955.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#containerize-the-app-and-deploy-to-ibm-cloud-private" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://rafal-szypulka.github.io/b2m-java" title="Build to Manage - Java application monitoring and logging lab" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Build to Manage - Java application monitoring and logging lab
              </span>
              <span class="md-header-nav__topic">
                5. Deploy to IBM Cloud Private
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/rafal-szypulka/b2m-java/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://rafal-szypulka.github.io/b2m-java" title="Build to Manage - Java application monitoring and logging lab" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Build to Manage - Java application monitoring and logging lab
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/rafal-szypulka/b2m-java/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="1. Introduction" class="md-nav__link">
      1. Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../logging/" title="2. WLP logging and Elastic stack integration" class="md-nav__link">
      2. WLP logging and Elastic stack integration
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../monitoring-instrumentation/" title="3. Java application monitoring instrumentation" class="md-nav__link">
      3. Java application monitoring instrumentation
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Prometheus-Grafana/" title="4. Prometheus and Grafana configuration" class="md-nav__link">
      4. Prometheus and Grafana configuration
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        5. Deploy to IBM Cloud Private
      </label>
    
    <a href="./" title="5. Deploy to IBM Cloud Private" class="md-nav__link md-nav__link--active">
      5. Deploy to IBM Cloud Private
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#containerize-the-app-and-deploy-to-ibm-cloud-private" title="Containerize the app and deploy to IBM Cloud Private" class="md-nav__link">
    Containerize the app and deploy to IBM Cloud Private
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-a-docker-container" title="Create a Docker container" class="md-nav__link">
    Create a Docker container
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-b2m-java-application-to-the-icp-cluster" title="Deploy b2m-java application to the ICP cluster" class="md-nav__link">
    Deploy b2m-java application to the ICP cluster
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#enable-monitoring-using-icp-prometheus-and-grafana" title="Enable monitoring using ICP Prometheus and Grafana" class="md-nav__link">
    Enable monitoring using ICP Prometheus and Grafana
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#define-kubernetes-liveness-probe-for-use-with-built-in-application-health-check" title="Define kubernetes liveness probe for use with built-in application health check" class="md-nav__link">
    Define kubernetes liveness probe for use with built-in application health check
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#containerize-the-app-and-deploy-to-ibm-cloud-private" title="Containerize the app and deploy to IBM Cloud Private" class="md-nav__link">
    Containerize the app and deploy to IBM Cloud Private
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-a-docker-container" title="Create a Docker container" class="md-nav__link">
    Create a Docker container
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-b2m-java-application-to-the-icp-cluster" title="Deploy b2m-java application to the ICP cluster" class="md-nav__link">
    Deploy b2m-java application to the ICP cluster
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#enable-monitoring-using-icp-prometheus-and-grafana" title="Enable monitoring using ICP Prometheus and Grafana" class="md-nav__link">
    Enable monitoring using ICP Prometheus and Grafana
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#define-kubernetes-liveness-probe-for-use-with-built-in-application-health-check" title="Define kubernetes liveness probe for use with built-in application health check" class="md-nav__link">
    Define kubernetes liveness probe for use with built-in application health check
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/rafal-szypulka/b2m-java/edit/master/docs/ICP.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                  <h1>5. Deploy to IBM Cloud Private</h1>
                
                <h2 id="containerize-the-app-and-deploy-to-ibm-cloud-private">Containerize the app and deploy to IBM Cloud Private<a class="headerlink" href="#containerize-the-app-and-deploy-to-ibm-cloud-private" title="Permanent link">&para;</a></h2>
<h3 id="create-a-docker-container">Create a Docker container<a class="headerlink" href="#create-a-docker-container" title="Permanent link">&para;</a></h3>
<p>Use provided <code>Dockerfile</code> to build application container:</p>
<div class="codehilite"><pre><span></span>docker build -t b2m-java .
</pre></div>


<p>Test container locally (make sure you stopped local WLP server).</p>
<div class="codehilite"><pre><span></span>docker run -d -p 9080:9080 b2m-java
</pre></div>


<p>Access the <code>http://localhost:9080/rsapp/checkout</code> to verify the application is running.</p>
<p>Now, our Java application container can be deployed on ICP cluster. Make sure the <code>kubectl</code> client is configured to connect to your ICP cluster. More information <a href="https://www.ibm.com/support/knowledgecenter/SSBS6K_3.1.1/manage_cluster/install_kubectl.html">here</a>.</p>
<p>The <code>b2m-java</code> application container image has been uploaded to public Docker Hub: <code>rszypulka/b2m-java</code>. You can also upload it to the local ICP Container Registry.</p>
<h3 id="deploy-b2m-java-application-to-the-icp-cluster">Deploy b2m-java application to the ICP cluster<a class="headerlink" href="#deploy-b2m-java-application-to-the-icp-cluster" title="Permanent link">&para;</a></h3>
<p>IBM provides helm charts for WebSphere Liberty and Open Liberty. These helm charts simplify configuration of monitoring and logging and allow to enable built-in <a href="https://www.ibm.com/support/knowledgecenter/en/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_mp_metrics_monitor.html">monitoring</a> and <a href="https://www.ibm.com/support/knowledgecenter/en/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/rwlp_logging.html">logging</a> features of Liberty without manual modification of Liberty config files we did earlier. WebSphere Liberty provides also a <a href="https://www.ibm.com/support/knowledgecenter/en/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_microprofile_healthcheck.html">health feature</a> that allows to implement application health checks and expose a health API that can be used by kubernetes <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/">liveness probe</a> as well as external monitoring tools. </p>
<p>Setup your CLI environment:</p>
<div class="codehilite"><pre><span></span>cloudctl login -a https://&lt;ICP_CLUSTER_IP&gt;:8443
</pre></div>


<p>replace <ICP_CLUSTER_IP> with the IP address of you ICP cluster.</p>
<p>Verify you can connect your helm client with tiller running in the ICP cluster:</p>
<div class="codehilite"><pre><span></span>$ helm version --tls
Client: &amp;version.Version{SemVer:&quot;v2.9.1&quot;, GitCommit:&quot;20adb27c7c5868466912eebdf6664e7390ebe710&quot;, GitTreeState:&quot;clean&quot;}
Server: &amp;version.Version{SemVer:&quot;v2.9.1+icp&quot;, GitCommit:&quot;8ddf4db6a545dc609539ad8171400f6869c61d8d&quot;, GitTreeState:&quot;clean&quot;}
</pre></div>


<p>Run the following command to deploy our java application on ICP Cluster:</p>
<div class="codehilite"><pre><span></span>helm install --name btm-java --namespace default ibm-charts/ibm-open-liberty \
--set monitoring.enabled=true \
--set image.repository=rszypulka/b2m-java \
--set image.tag=latest,ssl.enabled=false \
--set ssl.useClusterSSLConfiguration=false \
--set ssl.createClusterSSLConfiguration=false \
--set service.port=&#39;9080&#39; --set service.targetPort=&#39;9080&#39; \
--set ingress.enabled=false \
--set jmsService.enabled=false \
--set iiopService.enabled=false \
--set logs.persistLogs=false \
--set logs.persistTransactionLogs=false \
--set autoscaling.enabled=false \
--set resources.constraints.enabled=false \
--set microprofile.health.enabled=true \
--set sessioncache.hazelcast.enabled=false \
--set license=accept --tls
</pre></div>


<p>The command above is just an example and helm chart for WebSphere Liberty provides more options. More information <a href="https://github.com/IBM/charts/tree/master/stable/ibm-websphere-liberty">here</a>.
You can also deploy the WebSphere Liberty helm chart from the ICP Catalog.</p>
<p>Verify status of <code>btm-java</code> helm release:</p>
<div class="codehilite"><pre><span></span>$ helm status btm-java --tls
LAST DEPLOYED: Mon Mar 18 15:44:31 2019
NAMESPACE: default
STATUS: DEPLOYED

RESOURCES:
==&gt; v1/ConfigMap
NAME                      DATA  AGE
btm-java-ibm-open-libert  5     1h

==&gt; v1/Service
NAME                      TYPE      CLUSTER-IP  EXTERNAL-IP  PORT(S)         AGE
btm-java-ibm-open-libert  NodePort  10.0.0.122  &lt;none&gt;       9080:31936/TCP  1h

==&gt; v1/Deployment
NAME                      DESIRED  CURRENT  UP-TO-DATE  AVAILABLE  AGE
btm-java-ibm-open-libert  1        1        1           1          1h

==&gt; v1/Pod(related)
NAME                                      READY  STATUS   RESTARTS  AGE
btm-java-ibm-open-libert-b6cdbbd59-qw58b  1/1    Running  0         1h
</pre></div>


<p>Get the application URL by running these commands:</p>
<div class="codehilite"><pre><span></span>export NODE_PORT=$(kubectl get --namespace default \
-o jsonpath=&quot;{.spec.ports[0].nodePort}&quot; services btm-java-ibm-open-libert)

export NODE_IP=$(kubectl get nodes -l proxy=true \
-o jsonpath=&quot;{.items[0].status.addresses[?(@.type==\&quot;Hostname\&quot;)].address}&quot;)

echo http://$NODE_IP:$NODE_PORT
</pre></div>


<p>Use an internet browser or <code>curl</code> to access:
- Application URL: <code>http://$NODE_IP:$NODE_PORT/rsapp/checkout</code>
- Prometheus metrics URL: <code>http://$NODE_IP:$NODE_PORT/metrics</code>
- Health API URL: <code>http://$NODE_IP:$NODE_PORT/health</code></p>
<h2 id="enable-monitoring-using-icp-prometheus-and-grafana">Enable monitoring using ICP Prometheus and Grafana<a class="headerlink" href="#enable-monitoring-using-icp-prometheus-and-grafana" title="Permanent link">&para;</a></h2>
<p>Add the following configuration in the <code>monitoring-prometheus</code> ConfigMap, <code>scrape_configs:</code> section.</p>
<div class="codehilite"><pre><span></span>    scrape_configs:
      - job_name: &#39;b2m-java&#39;
        scrape_interval: 20s
        static_configs:
          - targets:
            - b2m-java.default.svc:80
            labels:
              service: &#39;btm-java&#39;
              group: &#39;production&#39;
</pre></div>


<p>Make sure the indentation is correct.</p>
<p><a href="http://docs.grafana.org/reference/export_import/">Import</a> provided Grafana dashboard <code>ibm-open-liberty-grafana-dashboard.json</code>.</p>
<p>Generate ICP application traffic using provided script:</p>
<div class="codehilite"><pre><span></span>./load_test_icp.sh &lt;application_url&gt;
</pre></div>


<p>Use the <code>&lt;application_url&gt;</code> collected in previous chapter.</p>
<p>Access the ICP Grafana console and verify it properly shows metrics.</p>
<h2 id="define-kubernetes-liveness-probe-for-use-with-built-in-application-health-check">Define kubernetes liveness probe for use with built-in application health check<a class="headerlink" href="#define-kubernetes-liveness-probe-for-use-with-built-in-application-health-check" title="Permanent link">&para;</a></h2>
<p>The WebSphere Liberty helm chart configures a default liveness and readiness probes that checks <code>/health</code> route. It can be modified if needed both during helm chart deployment (by configuring image.readinessProbe and image.livenessProbe parameters) or by editing the application deployment. The application container is considered healthy if connection can be established and http response code equals <code>200</code>, otherwise it's considered a failure.</p>
<p>More information about configuring liveness and readiness probes can be found <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/">here</a>.</p>
<p>The default liveness probe definition:</p>
<div class="codehilite"><pre><span></span>        livenessProbe:
          failureThreshold: 3
          httpGet:
            path: /health
            port: 9080
            scheme: HTTP
          initialDelaySeconds: 20
          periodSeconds: 5
          successThreshold: 1
          timeoutSeconds: 1
</pre></div>


<p>Check the URL: <code>http://&lt;node_external_ip&gt;:&lt;external_nodeport&gt;/health</code> to verify current health status.</p>
<blockquote>
<p>Expected output: <code>{"checks":[],"outcome":"UP"}</code></p>
</blockquote>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../Prometheus-Grafana/" title="4. Prometheus and Grafana configuration" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                4. Prometheus and Grafana configuration
              </span>
            </div>
          </a>
        
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.b41f3d20.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
    
      
    
  </body>
</html>